import QtQuick
import Quickshell
import Quickshell.Wayland
import Quickshell.Io
import qs.Core

PanelWindow {
    id: root

    property bool isOpen: false
    required property var globalState
    required property Colors colors
    property var malwareSignatures: []
    property var detectedMalware: []
    property bool scanning: false

    function scanSystem() {
        root.scanning = true
        root.detectedMalware = []
        
        // Scan for common malware locations
        var scanPaths = [
            "/tmp",
            "/var/tmp",
            Quickshell.env("HOME") + "/Downloads",
            Quickshell.env("HOME") + "/.cache"
        ]
        
        var malwareNames = [
            "keylogger", "trojan", "backdoor", "rootkit", "spyware",
            "ransomware", "adware", "malware", "virus", "worm"
        ]
        
        for (var i = 0; i < scanPaths.length; i++) {
            var proc = Quickshell.exec(["find", scanPaths[i], "-type", "f", "-name", "*", "2>/dev/null"])
            var files = proc.stdout.split('\n')
            
            for (var j = 0; j < files.length; j++) {
                var fileName = files[j].toLowerCase()
                for (var k = 0; k < malwareNames.length; k++) {
                    if (fileName.includes(malwareNames[k])) {
                        root.detectedMalware.push({
                            path: files[j],
                            type: malwareNames[k],
                            severity: "high"
                        })
                    }
                }
            }
        }
        
        root.scanning = false
    }

    function removeMalware(path) {
        Quickshell.execDetached(["rm", "-rf", path])
        root.scanSystem()
    }

    color: "transparent"
    visible: isOpen
    implicitWidth: 700
    implicitHeight: 600
    WlrLayershell.layer: WlrLayer.Overlay
    WlrLayershell.namespace: "malware-detector"
    WlrLayershell.exclusiveZone: -1

    anchors {
        bottom: true
        horizontalCenter: true
    }

    Rectangle {
        anchors.fill: parent
        color: colors.surface
        radius: 15
        border.width: 1
        border.color: colors.border

        Column {
            anchors.fill: parent
            anchors.margins: 20
            spacing: 15

            Text {
                text: "Malware Detector"
                font.pixelSize: 20
                font.bold: true
                color: colors.fg
            }

            Rectangle {
                width: parent.width
                height: 60
                radius: 10
                color: root.detectedMalware.length > 0
                    ? Qt.rgba(1, 0, 0, 0.2)
                    : Qt.rgba(0, 1, 0, 0.2)

                Column {
                    anchors.centerIn: parent
                    spacing: 5

                    Text {
                        anchors.horizontalCenter: parent.horizontalCenter
                        text: root.detectedMalware.length > 0 ? "MALWARE DETECTED" : "SYSTEM CLEAN"
                        font.pixelSize: 16
                        font.bold: true
                        color: root.detectedMalware.length > 0 ? "#ff4444" : "#44ff44"
                    }

                    Text {
                        anchors.horizontalCenter: parent.horizontalCenter
                        text: "Threats: " + root.detectedMalware.length
                        font.pixelSize: 12
                        color: colors.muted
                    }
                }
            }

            Rectangle {
                width: parent.width
                height: 40
                radius: 8
                color: colors.accent

                Text {
                    anchors.centerIn: parent
                    text: root.scanning ? "Scanning..." : "Scan System"
                    font.pixelSize: 14
                    font.bold: true
                    color: colors.bg
                }

                MouseArea {
                    anchors.fill: parent
                    enabled: !root.scanning
                    onClicked: root.scanSystem()
                }
            }

            Text {
                text: "Detected Malware"
                font.pixelSize: 16
                font.bold: true
                color: colors.fg
                visible: root.detectedMalware.length > 0
            }

            ListView {
                width: parent.width
                height: 350
                model: root.detectedMalware

                delegate: Rectangle {
                    width: parent.width
                    height: 80
                    radius: 6
                    color: Qt.rgba(1, 0, 0, 0.1)
                    border.width: 2
                    border.color: "#ff4444"

                    Column {
                        anchors.left: parent.left
                        anchors.leftMargin: 10
                        anchors.verticalCenter: parent.verticalCenter
                        spacing: 5

                        Text {
                            text: "Type: " + modelData.type.toUpperCase()
                            font.pixelSize: 12
                            font.bold: true
                            color: "#ff4444"
                        }

                        Text {
                            text: modelData.path
                            font.pixelSize: 11
                            font.family: "monospace"
                            color: colors.fg
                            width: parent.width - 100
                            elide: Text.ElideLeft
                        }

                        Text {
                            text: "Severity: " + modelData.severity.toUpperCase()
                            font.pixelSize: 10
                            color: colors.muted
                        }
                    }

                    Rectangle {
                        anchors.right: parent.right
                        anchors.rightMargin: 10
                        anchors.verticalCenter: parent.verticalCenter
                        width: 70
                        height: 35
                        radius: 5
                        color: "#ff4444"

                        Text {
                            anchors.centerIn: parent
                            text: "Remove"
                            font.pixelSize: 11
                            font.bold: true
                            color: "#ffffff"
                        }

                        MouseArea {
                            anchors.fill: parent
                            onClicked: root.removeMalware(modelData.path)
                        }
                    }
                }
            }
        }
    }
}

